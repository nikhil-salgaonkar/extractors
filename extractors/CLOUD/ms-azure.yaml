schema-version: 1.0
#extractor-version: 1
extractor-id: 722
integration: Azure 
vendor-name: Microsoft Azure
product-name: Azure 
source-name:  AZURE 
source-type: CLOUD
source-description: Extractor for Azure Events
provides-streams:
- AZURE
- FIREWALL
master-filters:
- '\"resourceId\"\:.*?\"operationName\"\:.*?\"(?:recommendationCategory|category)\"\:'
- '\"(?:TaskName|EventName)\"\:.*?resourceId\"\:.*?\"category\"\:\"\w+\"'
- '\"resourceId\".*?\"metricName\"\:\"\w+\"\,\"timeGrain\"\:'
- '\"operationName\":\"NetworkSecurityGroupFlowEvents\"'
event-details:
- first-match: '\"category\"\:\"\w+\"\,\"resultType\"\:\"\w+\"'
  decoder: json
  event-key-format: '{category}-{resultType}-{properties[eventCategory]}'
  event-key-mapping: 
    'Action-Failure-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ACTIVITY
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName

    'Action-Start-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ACTIVITY
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName    

    'Action-Success-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ACTIVITY
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Action-Success-Policy':
      annotate:
        Stream: AZURE
        Action: AZURE_ACTIVITY
        Status: PASSED
        EventName: POLICY
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName      

    'Action-Accept-Administrative': 
      annotate:
        Stream: AZURE
        Action: AZURE_ACTIVITY
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName        

    'Write-Failure-Administrative':   
      annotate:
        Stream: AZURE
        Action: AZURE_WRITE
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName

    'Write-Start-Administrative':   
      annotate:
        Stream: AZURE
        Action: AZURE_WRITE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName

    'Write-Success-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_WRITE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName    

    'Write-Accept-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_WRITE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName    

    'Read-Failure-Administrative':   
      annotate:
        Stream: AZURE
        Action: AZURE_READ
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName

    'Read-Start-Administrative':   
      annotate:
        Stream: AZURE
        Action: AZURE_READ
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName

    'Read-Success-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_READ
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName    

    'Read-Accept-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_READ
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Delete-Failure-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_DELETE
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName        

    'Delete-Start-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_DELETE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName         

    'Delete-Success-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_DELETE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName      

    'Delete-Accept-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_DELETE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName  

    'Administrative-Start-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Administrative-Success-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Administrative-Accept-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Administrative-Failure-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        properties[eventCategory]: Category
        identity[claims][name]: User
        operationName: OperationName 

    'Policy-Start-Policy':
      annotate:
        Stream: AZURE
        Action: AZURE_POLICY
        Status: PASSED
        EventName: POLICY
      translate:  
        properties[eventCategory]: Category
        User: User
        operationName: OperationName   

    'Policy-Success-Policy':
      annotate:
        Stream: AZURE
        Action: AZURE_POLICY
        Status: PASSED
        EventName: POLICY
      translate:  
        properties[eventCategory]: Category
        User: User
        operationName: OperationName                          

  fallback:
    annotate:
      EventName: Generic Azure Event 
      Stream: OTHER

  globals:
    translate:
      System: System
      time: SystemTstamp  

- first-match: '\"resultType\"\:\"\w+\"\,.*?\"category\"\:\"\w+\"\,.*?\"eventCategory\"'
  decoder: json
  event-key-format: '{resultType}-{category}-{properties[eventCategory]}'
  event-key-mapping: 
    'Started-Administrative-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        category: Category
        User: User
        operationName: OperationName      

    'Succeeded-Administrative-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
        EventName: ADMINISTRATIVE
      translate:  
        category: Category
        User: User
        operationName: OperationName   

    'Failed-Administrative-Administrative':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: FAILED
        EventName: ADMINISTRATIVE
      translate:  
        category: Category
        User: User
        operationName: OperationName   

  fallback:
    annotate:
      EventName: Generic Azure Event
      Stream: OTHER

  globals:
    translate:
      System: System
      time: SystemTstamp       

- first-match: '\"EventName\":\"AzureBackupActivityLog\"\,'
  decoder: json
  event-key-format: '{category}-{resultType}'
  event-key-mapping: 
    'Administrative-Succeeded':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
      translate:  
        category: Category
        User: User
        operationName: OperationName
        EventName: EventName

    'Administrative-Failed':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: FAILED
      translate:  
        category: Category
        User: User
        operationName: OperationName
        EventName: EventName   

    'Administrative-Started':
      annotate:
        Stream: AZURE
        Action: AZURE_ADMINISTRATIVE
        Status: PASSED
      translate:  
        category: Category
        User: User
        operationName: OperationName  
        EventName: EventName   

  fallback:
    annotate:
      EventName: Generic Azure Event
      Stream: OTHER

  globals:
    translate:
      System: System
      time: SystemTstamp 

- first-match: '\"recommendationCategory\"\:\"\w+\"\,'
  decoder: json
  event-key-format: '{resultType}-{properties[recommendationCategory]}'
  event-key-mapping: 
    'Active-HighAvailability':
      annotate:
        Stream: AZURE
        Action: AZURE_RECOMMENDATION
        Status: PASSED
        EventName: RECOMMENDATION
      translate:  
        category: Category
        User: User
        operationName: OperationName      

    'Active-Performance':
      annotate:
        Stream: AZURE
        Action: AZURE_RECOMMENDATION
        Status: PASSED
        EventName: RECOMMENDATION
      translate:  
        category: Category
        User: User
        operationName: OperationName   

    'Active-Security':
      annotate:
        Stream: AZURE
        Action: AZURE_RECOMMENDATION
        Status: PASSED
        EventName: RECOMMENDATION
      translate:  
        category: Category
        User: User
        operationName: OperationName  

    'Active-Cost':
      annotate:
        Stream: AZURE
        Action: AZURE_RECOMMENDATION
        Status: PASSED
        EventName: RECOMMENDATION
      translate:  
        category: Category
        User: User
        operationName: OperationName     

  fallback:
    annotate:
      EventName: Generic Azure Event
      Stream: OTHER

  globals:
    translate:
      System: System
      time: SystemTstamp                

- first-match: 'Status\"\:\"\w+\".*?\"category\"\:\"OperationalLogs\"'
  decoder: json
  event-key-format: '{category}-{Status}'
  event-key-mapping: 
    'OperationalLogs-Succeeded':
      annotate:
        Stream: AZURE
        Action: AZURE_OPERATION
        Status: PASSED
      translate:  
        category: Category
        Caller: User
        EventName: EventName
        OperationName: OperationName  

  fallback:
    annotate:
      EventName: Generic Azure Event
      Stream: OTHER

  globals:
    translate:
      System: System
      EventTimeString: SystemTstamp       

- first-match: '\"failures\"\:\d+\,.*?\"category\"\:\"ArchiveLogs\"'
  decoder: json
  event-key-format: '{category}'
  event-key-mapping: 
    'ArchiveLogs':
      annotate:
        Stream: AZURE
        Action: AZURE_ARCHIVE
        Status: FAILED
        EventName: ARCHIVELOGS
      translate:  
        category: Category
        User: User
        OperationName: OperationName

  fallback:
    annotate:
      EventName: Generic Azure Event
      Stream: OTHER

  globals:
    translate:
      System: System
      startTime: SystemTstamp

- first-match: '\"operationName\":\"NetworkSecurityGroupFlowEvents\"'
  decoder: json
  event-key-format: '{Version}-{flowPacket}'
  event-key-mapping: 
    '1-A':
      annotate:
        Stream: FIREWALL
        Action: CONNECTION_ESTABLISHED
        Status: PASSED
      translate:  
        flowSrc: SrcIP
        flowSPort: SrcPort
        flowDst: DstIP
        flowDPort: DstPort
        flowProto: Proto
        App: App
        flowBytesSentSrcToDst: TXLen
        flowBytesSentDstToSrc: RXLen
    '1-D':
      annotate:
        Stream: FIREWALL
        Action: CONNECTION_ESTABLISHED
        Status: FAILED
      translate:  
        flowSrc: SrcIP
        flowSPort: SrcPort
        flowDst: DstIP
        flowDPort: DstPort
        flowProto: Proto
        App: App
        flowBytesSentSrcToDst: TXLen
        flowBytesSentDstToSrc: RXLen
    '2-A':
      annotate:
        Stream: FIREWALL
        Action: PACKET_ALLOWED
        Status: PASSED
      translate:  
        flowSrc: SrcIP
        flowSPort: SrcPort
        flowDst: DstIP
        flowDPort: DstPort
        flowProto: Proto
        App: App
        flowBytesSentSrcToDst: TXLen
        flowBytesSentDstToSrc: RXLen
    '2-D':
      annotate:
        Stream: FIREWALL
        Action: PACKET_BLOCKED
        Status: PASSED
      translate:  
        flowSrc: SrcIP
        flowSPort: SrcPort
        flowDst: DstIP
        flowDPort: DstPort
        flowProto: Proto
        App: App
        flowBytesSentSrcToDst: TXLen
        flowBytesSentDstToSrc: RXLen

  fallback:
    annotate:
      EventName: Generic Azure Event 
      Stream: OTHER

  globals:
    translate:
      System: System
      time: SystemTstamp

  subs:
    Proto: 
      'T': 'TCP'
      'U': 'UDP'