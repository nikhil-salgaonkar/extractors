schema-version: 1.0
#extractor-version: 1
extractor-id: 724
integration: AWS S3
vendor-name: Amazon
product-name: AWS Security Hub
source-name: AWS-SECURITY-HUB
source-type: CLOUD
source-description: Extractor for AWS Security Hub Events
provides-streams:
- COMPLIANCE
- SECURITY-HUB
- CONFIGURATION
- THREAT
master-filters:
- '\"ProductArn\"\:\s*\"arn\:aws\:\:?securityhub\:[\w\:\-\/]+\"'
event-details:  
- first-match: '\"ProductArn\"\:\s*\"arn\:aws\:securityhub\:[\w\-\:\/]+\/securityhub\".*?\"Compliance\"\:'
  decoder: json
  event-key-format: '{detail[findings][0][Compliance][Status]}'         
  event-key-mapping:
    'PASSED':  
      annotate: 
        Stream: COMPLIANCE
        Action: COMPLIANCE_CHECK
        Status: PASSED
        Event: Host is compliant.
      translate:
        account: Account  
        detail[findings][0][AwsAccountId]: AccountID
        detail[findings][0][Title]: Policy
    'FAILED':  
      annotate: 
        Stream: COMPLIANCE
        Action: COMPLIANCE_CHECK
        Status: FAILED
        Event: Host is not compliant.
      translate:
        detail[findings][0][Compliance][StatusReasons][0][ReasonCode]: Reason
        account: Account  
        detail[findings][0][AwsAccountId]: AccountID
        detail[findings][0][Title]: Policy                                                                                         

  fallback:
    annotate:
      EventName: Generic AWS Security Hub Event
      Stream: OTHER

  globals:
    translate:
      detail[findings][0][CreatedAt]: SystemTstamp
      System: System

- first-match: '\"ProductArn\"\:\s*\"arn\:aws\:\:securityhub\:[\w\-\:\/]+\/guardduty\".*?\"Types\"\:\[\".*?UnauthorizedAccess\:(?:S3|EC2|IAMUser)\-.*?\"\]'
  decoder: json
  event-key-format: ''         
  event-key-mapping:
    '':  
      annotate: 
        Stream: THREAT
        Action: THREAT_DETECTED
        Status: PASSED
        Vector: AUTHENTICATION
      translate:
        Title: Threat
        AwsAccountId: User
        ProductFields[aws/guardduty/service/action/networkConnectionAction/remoteIpDetails/ipAddressV4]: SrcIP
    
  fallback:
    annotate:
      EventName: Generic AWS Security Hub Event
      Stream: OTHER

  globals:
    translate:
      CreatedAt: SystemTstamp
      System: System

- first-match: '\"ProductArn\"\:\s*\"arn\:aws\:\:securityhub\:[\w\-\:\/]+\/guardduty\".*?\"Types\"\:\[\".*?Policy\:S3\-.*?\"\]'
  decoder: json
  event-key-format: ''         
  event-key-mapping:
    '':  
      annotate: 
        Stream: CONFIGURATION
        Action: CONFIGURATION_CHANGED
        Status: PASSED
      translate:
        Title: Config
        AwsAccountId: User
    
  fallback:
    annotate:
      EventName: Generic AWS Security Hub Event
      Stream: OTHER

  globals:
    translate:
      CreatedAt: SystemTstamp
      System: System

- first-match: '\"ProductArn\"\:\s*\"arn\:aws\:securityhub\:[\w\-\:\/]+\/(?:macie|inspector|ssm\-patch\-manager|access\-analyzer)\"'
  decoder: json
  event-key-format: ''         
  event-key-mapping:
    '':  
      annotate: 
        Stream: SECURITY-HUB
      translate:
        Title: EventName
        detail[findings][0][Title]: EventName
        ProductArn: ProductArn
        detail[findings][0][ProductArn]: ProductArn
    
  fallback:
    annotate:
      EventName: Generic AWS Security Hub Event
      Stream: OTHER

  globals:
    translate:
      CreatedAt: SystemTstamp
      System: System