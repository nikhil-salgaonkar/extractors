schema-version: 1.0
#extractor-version: 1
extractor-id: 123
integration: Syslog
vendor-name: Zimbra
product-name: Zimbra
source-name: ZIMBRA
source-type: MAILSERVER
source-description: Extractor for Zimbra Mailserver Events
provides-streams:
- AUTHENTICATION
- EMAIL-GATEWAY
- CONFIGURATION
master-filters:
- '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+\S+(?:\[\d+\]\:|\w+\:|[\w\.])'
event-details:
- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+\S+\[\d+\]\:\s+do\_auth'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\w+)\[(?P<pid>\d+)\]\:\s+\S+\s+\:\s+(?P<msg>(?P<action>[\s\w]+)\:.*?user\=(?P<user>\S+)\]\s+\[service\=(?P<authproto>\S+)\].*)'
  event-key-format: '{action}'
  event-key-mapping:
    'auth failure':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        SrcIP: SrcIP
        authproto: AuthProto

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System       

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+\S+\[\d+\]\:\s+(?:auth\_zimbra|warning)\:'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\[(?P<pid>\d+)\]\:\s+\S+\:\s+.*?(?:(?P<user>[^\]\[\s]+))?(?:\[(?P<src>[\d\.]+)\]\:)?\s+(?P<msg>.*?(?P<action>(?:auth|authentication)\s+failed)\:.*)'
  event-key-format: '{action}'
  event-key-mapping:
    'auth failed':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        SrcIP: SrcIP
        AuthProto: AuthProto
    
    'authentication failed': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto   

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System 

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+\S+\[\d+\]\:(?:\s+|[\s\w]+)(?:lost\s+connection|connect|CONNECT|disconnect|connection\s+established|DISCONNECT|timeout)\s+'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\[(?P<pid>\d+)\]\:\s+(?P<msg>.*?(?P<action>(?:connect|CONNECT|lost\s+connection|disconnect|connection\s+established|DISCONNECT|timeout))\s+.*?(?:(?P<user>[^\]\[\s]+))?\[(?P<src>[\d\.]+)\].*)'
  event-key-format: '{action}'
  event-key-mapping: 
    'lost connection': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto   

    'connect': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto    

    'CONNECT': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        User: User
        src: SrcIP
        AuthProto: AuthProto   

    'disconnect': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto 

    'connection established': 
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto 

    'DISCONNECT':  
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto        

    'timeout':  
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto     

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System      

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+mailboxd\:'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\w+)\:\s+.*?\[name\=(?P<user>\S+)\;(?:oip|ip)\=(?P<src>[\d\.]+).*?\;\]\s+(?P<msg>.*?(?P<action>authentication\s+failed|SMIME feature not enabled).*)'
  event-key-format: '{action}'
  event-key-mapping:
    'authentication failed':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS 
      translate:
        user: User
        src: SrcIP
        AuthProto: AuthProto

    'SMIME feature not enabled':
      annotate:
        Stream: CONFIGURATION
        Action: CONFIGURATION_CHANGED
        Status: FAILED
        Config: SMIME feature not enabled
      translate:
        user: User

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System    

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+(?:systemd\:|filebeat\:|com\.zimbra\.cs\.[\w\.]+)'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\s+(?P<msg>.*?(?P<action>Starting\s+Session|connection\s+refused|authentication\s+failed|Starting).*?(?:(?:(?:user|User)\s+|for\s+\[)(?P<user>\w+))?.*)'
  event-key-format: '{action}'
  event-key-mapping:
    'Starting Session':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        user: User
        SrcIP: SrcIP
        AuthProto: AuthProto

    'connection refused':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS
      translate:
        User: User
        SrcIP: SrcIP
        AuthProto: AuthProto   

    'authentication failed':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_CREDENTIALS
      translate:
        user: User
        SrcIP: SrcIP
        AuthProto: AuthProto 

    'Starting':
      annotate:
        Stream: CONFIGURATION
        Action: CONFIGURATION_CHANGED
        Status: PASSED
        Config: Starting User
      translate:
        user: User
       
  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System    

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+postfix\/\w+\[\d+\]\:.*?(?:proxy\-reject|reject|redirect)\:'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\[(?P<pid>\d+)\]\:.*?(?P<msg>(?P<action>(?:proxy-reject|reject|redirect))\:(?:.*?(?:client\s+\[|from\s+\S+\[)(?P<remoteip>[\w\.]+)\])?.*?from\=\<(?P<sender>\S+)\>.*?to\=\<(?P<recipient>\S+)\>.*)'
  event-key-format: '{action}'
  event-key-mapping:
    'proxy-reject':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_BLOCKED
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        RemoteIP: RemoteIP
        File: File
        Direction: Direction

    'reject':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_SERVICE_UNAVAILABLE
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction  

    'redirect': 
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_REDIRECT
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction              

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System     

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+amavis\[\d+\]\:'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\[(?P<pid>\d+)\]\:.*?(?P<msg>(?P<action>FWD|Passed\s+CLEAN|Checking|ESMTP|Blocked\s+SPAM)(?:.*?\[(?P<remoteip>[\d\.]+)\]\s+)?.*?\<(?P<sender>\S+)\>\s+\-\>\s+\<(?P<recipient>\S+)\>.*)'
  event-key-format: '{action}'
  event-key-mapping:
    'FWD':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_FORWARD
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        RemoteIP: RemoteIP
        File: File
        Direction: Direction

    'Passed CLEAN':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_PASSED
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        RemoteIP: RemoteIP
        File: File
        Direction: Direction 

    'Checking':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_CHECK
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        RemoteIP: RemoteIP
        File: File
        Direction: Direction  

    'ESMTP':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_DELIVERED
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        RemoteIP: RemoteIP
        File: File
        Direction: Direction

    'Blocked SPAM':
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_SPAM_BLOCKED
        Status: PASSED
      translate:
        sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction             
                  

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System 

- first-match: '^(?:\<\d+\>)?\w{3}\s+\d{1,2}\s+\d{1,2}\:\d{1,2}\:\d{1,2}\s+\S+\s+postfix\/\w+\[\d+\]\:.*?(?:handshake\s+failure|Delivery\s+OK|Connection\s+timed\s+out|Message\s+source\s+blocked\s+permanently)'
  decoder: regex
  decoder-regex: '^(?:\<\d+\>)?(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+(?P<daemon>\S+)\[(?P<pid>\d+)\]\:\s+(?P<msg>.*?to\=\<(?P<recipient>\S+)\>\,.*?\[(?P<remoteip>[\d\.]+)\].*?(?P<action>handshake\s+failure|Delivery\s+OK|Connection\s+timed\s+out|Message\s+source\s+blocked\s+permanently).*)'
  event-key-format: '{action}'
  event-key-mapping:  
    'handshake failure':  
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_SUSPENDED
        Status: FAILED
      translate:
        Sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction   

    'Delivery OK':  
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_DELIVERED
        Status: PASSED
      translate:
        Sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction

    'Connection timed out':  
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_FAILED
        Status: FAILED
      translate:
        Sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction 

    'Message source blocked permanently': 
      annotate:
        Stream: EMAIL-GATEWAY
        Action: EMAIL_BLOCKED
        Status: PASSED
      translate:
        Sender: Sender
        recipient: Recipient
        Subject: Subject
        remoteip: RemoteIP
        File: File
        Direction: Direction           

  fallback:
    annotate:
      EventName: Generic Zimbra Mailserver Events
      Stream: OTHER

  globals:
    translate:
      datetime: SystemTstamp
      hostname: System                    