schema-version: 1.0
#extractor-version: 1
extractor-id: 97
source-name: PALOALTO
source-type: FIREWALL
source-description: Extractor for PaloAlto Firewall Events
provides-streams:
- FIREWALL
- THREAT
- AUTHENTICATION
master-filters:
- '^(?:\<\d+\>)?\w+\s+\d+\s+\d+\:\d+\:\d+\s+\S+\s+\d+\,\d+\/\d+\/\d+\s+\d+\:\d+\:\d+\,\d+\,.*?(?:TRAFFIC|THREAT|SYSTEM|CONFIG|USERID\,login|GLOBALPROTECT)\,'
event-details:
- first-match: '\,TRAFFIC\,.*?\,\S+\,'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostnmae>\S+)\s+\d+\,\d+\/\d+\/\d+\s+\d+\:\d+\:\d+\,\d+\,(?P<event_type>\w+)\,(?P<subtype>\w+)\,\d+\,[\d\/\:\s]+\,(?P<src>[\d\.]+)\,(?P<dst>[\d\.]+)\,(?P<srctranip>[\d\.]+)\,(?P<dsttranip>[\d\.]+)\,(?P<rule>.*?)\,(?P<suser>.*?)\,(?P<duser>.*?)\,(?P<app>.*?)\,.*?\,(?P<szone>.*?)\,(?P<dzone>.*?)\,(?P<iface_in>.*?)\,(?P<iface_out>.*?)\,.*?\,.*?\,.*?\,.*?\,(?P<sport>\d+)\,(?P<dport>\d+)\,(?P<srctranport>\d+)\,(?P<dsttranport>\d+)\,.*?\,(?P<proto>.*?)\,(?P<action>.*?)\,(?P<length>\d+)\,(?P<sent_bytes>\d+)\,(?P<receive_bytes>\d+)\,.*?\,\d+\/\d+\/\d+\s+\d+\:\d+\:\d+\,.*?\,(?P<siteclass>.*?)\,.*?\,\d+\,.*?\,.*?\,.*?\,\d+\,\d+\,\d+\,(?P<reason>.*?)\,'
  event-key-format: '{event_type}-{subtype}'
  event-key-mapping:
    'TRAFFIC-start':
      annotate:
        Stream: FIREWALL
        Action: PACKET_ALLOWED
        Status: PASSED
      translate:
        src: SrcIP
        dst: DstIP
        sport: SrcPort
        dport: DstPort
        app: App
        proto: Proto  
        sent_bytes: TXLen
        receive_bytes: RXLen
    'TRAFFIC-end':
      annotate:
        Stream: FIREWALL
        Action: PACKET_BLOCKED
        Status: FAILED
      translate:
        src: SrcIP
        dst: DstIP
        sport: SrcPort
        dport: DstPort
        app: App
        proto: Proto  
        sent_bytes: TXLen
        receive_bytes: RXLen
    'TRAFFIC-drop':
      annotate:
        Stream: FIREWALL
        Action: PACKET_ALLOWED
        Status: FAILED
      translate:
        src: SrcIP
        dst: DstIP
        sport: SrcPort
        dport: DstPort
        app: App
        proto: Proto  
        sent_bytes: TXLen
        receive_bytes: RXLen 
    'TRAFFIC-deny':   
      annotate:
        Stream: FIREWALL
        Action: PACKET_BLOCKED
        Status: PASSED
      translate:
        src: SrcIP
        dst: DstIP
        sport: SrcPort
        dport: DstPort
        app: App
        proto: Proto  
        sent_bytes: TXLen
        receive_bytes: RXLen                                    

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp

- first-match: '\,THREAT\,.*?\,'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostnmae>\S+)\s+\d+\,\d+\/\d+\/\d+\s+\d+\:\d+\:\d+\,\d+\,(?P<event_type>\w+)\,.*?\,\d+\,[\d\/\:\s]+\,(?P<src>[\d\.]+)\,(?P<dst>[\d\.]+)\,(?P<srctranip>[\d\.]+)\,(?P<dsttranip>[\d\.]+)\,(?P<rule>.*?)\,(?P<suser>.*?)\,(?P<duser>.*?)\,(?P<app>.*?)\,.*?\,(?P<szone>.*?)\,(?P<dzone>.*?)\,(?P<iface_in>.*?)\,(?P<iface_out>.*?)\,.*?\,.*?\,.*?\,.*?\,(?P<sport>\d+)\,(?P<dport>\d+)\,(?P<srctranport>\d+)\,(?P<dsttranport>\d+)\,.*?\,(?P<proto>.*?)\,(?P<action>.*?)\,\"?(?P<objecttype>.*?)\"?\,((?P<threat>.*?)\((?P<eventid>\d+)\))\,(?P<siteclass>.*?)\,(?P<severity>.*?)\,'
  event-key-format: '{event_type}'
  event-key-mapping:
    'THREAT':
      annotate:
        Stream: THREAT
        Action: THREAT_DETECTED
        Status: PASSED
        Vector: WEB
      translate:
        src: SrcIP
        dst: DstIP
        suser: User
        threat: Threat                                            

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp

- first-match: '\,SYSTEM\,.*?(?:auth\-success|auth-fail)'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+\d+\,.*?\,.*?\,(?P<event_type>\w+)\,.*?\,.*?\,.*?\,.*?\,(?P<action>.*?)\,.*?\,.*?\,.*?\,.*?\,(?P<severity>.*?)\,.*?(?P<message>(?:User|user)\s+(?P<user>.*?)\s+.*?(?:Reason\:\s+(?P<reason>.*?)\s+)?(?:From|from)\:?\s+(?P<src>[\w\.\:]+))\.?\"?\,(?:.*?method\s+(?P<auth_proto>.*?)\s+)?'
  event-key-format: '{action}'
  event-key-mapping:
    'auth-success':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        src: SrcIP
        user: User
        auth_proto: AuthProto
    'auth-fail':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
        Reason: INVALID_PASSWORD
      translate:
        src: SrcIP
        user: User  
        auth_proto: AuthProto                                    

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp 

- first-match: '\,SYSTEM\,.*?\s+(?:logged\s+out|logged\s+in)'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+\d+\,.*?\,.*?\,(?P<event_type>\w+)\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,(?P<severity>.*?)\,.*?(?P<message>(?:User|user)\s+(?P<user>.*?)\s+(?P<action>logged\s+(?:out|in)).*?(?:Reason\:\s+(?P<reason>.*?)\s+)?(?:From|from)\:?\s+(?P<src>[\w\.\:]+))\.?\"?'
  event-key-format: '{action}'
  event-key-mapping:
    'logged out':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGOUT
        Status: PASSED
      translate:
        src: SrcIP
        user: User
        auth_proto: AuthProto
    'logged in':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        src: SrcIP
        user: User  
        auth_proto: AuthProto                                            

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp  

- first-match: '\,SYSTEM\,.*?\s+user\s+authentication\s+(?:failed|succeeded)'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+\d+\,.*?\,.*?\,(?P<event_type>\w+)\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,(?P<severity>.*?)\,\"(?P<message>.*?(?P<action>authentication\s+(?:failed|succeeded)).*?\s+Login\s+from\:\s+(?P<src>\S+)\,.*?User\s+name\:\s+(?P<user>.*?)\,.*?(?:.*?Reason\:\s+(?P<reason>.*?)\,)?.*?)\"\,'
  event-key-format: '{action}'
  event-key-mapping:
    'authentication failed':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: FAILED
      translate:
        src: SrcIP
        user: User
        reason: Reason
        auth_proto: AuthProto
    'authentication succeeded':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        src: SrcIP
        user: User
        auth_proto: AuthProto                                             

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp  

- first-match: '\w{3}\s+\d+\s+\d{2}\:\d{2}\:\d{2}\s+\S+\s+\d+\,\d{4}\/\d{1,2}\/\d{1,2}\s+\d{2}\:\d{2}\:\d{2}\,\d+\,\d+\,[\dx]+\,GLOBALPROTECT\,\d+\,\d+\,\d+\/\d+\/\d+\s+\d+\:\d+\:\d+\,\w+\,gateway\-logout\,'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+\d+\,.*?\,.*?\,\w+\,.*?\,(?P<daemon>.*?)\,.*?\,.*?\,.*?\,.*?\,(?P<message>.*?)\,(?P<event_type>.*?)\,.*?\,.*?\,(?P<user>.*?)\,.*?\".*?\".*?\"(?P<EvtDesc>.*?)\"'
  event-key-format: '{event_type}'
  event-key-mapping:
    'logout':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGOUT
        Status: PASSED
      translate:
        user: User 
        src: SrcIP
        auth_proto: AuthProto                                              

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp

- first-match: 'SYSTEM\,general\,.*?\,\"\s+Accepted\s+password\s+'
  decoder: regex
  decoder-regex: '(?P<datetime>\w{3}\s+\d{1,2}\s+\d{2}\:\d{2}\:\d{2})\s+(?P<hostname>\S+)\s+\d+\,.*?\,.*?\,(?P<event_type>\w+)\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,.*?\,(?P<severity>.*?)\,\"(?P<message>.*?(?P<action>Accepted\s+password)\s+for\s+(?P<user>.*?)\s+from\s+(?P<src>\S+)\s+port\s+(?P<sport>\d+)\s+.*?)\"\,'
  event-key-format: '{action}'
  event-key-mapping:
    'Accepted password':
      annotate:
        Stream: AUTHENTICATION
        Action: LOGIN
        Status: PASSED
      translate:
        user: User 
        src: SrcIP
        auth_proto: AuthProto

  fallback:
    annotate:
      EventName: Generic PaloAlto Firewall Event
      Stream: OTHER

  globals:
    translate:
      hostname: System
      datetime: SystemTstamp